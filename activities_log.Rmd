---
title: "Activity Log of UNSIAP Data Visualization E-Learning Course"
author: "Jing Zhao and Christophe Bontemps"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:  
    code_folding: hide
    highlight: tango
    number_sections: yes
    theme: lumen
  html_notebook: default
  pdf_document: default
---

```{r setup, include=FALSE}
# Code folding oprion needs echo = TRUE to work 

knitr::opts_chunk$set( message = FALSE, warning = FALSE, 
                       results =FALSE, echo = TRUE, 
                       dev="png", 
                       fig.align = 'center',
                       dev.args=list(type="cairo"), dpi=96)

# Some colors we may want to use
SIAP.color <- "#0385a8"


```


```{r libraries}
# get knit worked for Mac
library(Cairo)
#
library(stringr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)

```

# Import data &  Clean data

```{r data}

date <- 20210127

data_log <- read.csv(paste0("Data/logs_DTV20_", date,".csv"))

file <- paste0("Data/logs_DTV20_", date,".csv") 
```


```{r}
data_log <- data_log[!(data_log$User.full.name=="Christophe Bontemps" | data_log$User.full.name=="Ni Ni Thein" | data_log$Component=="Recycle bin"),]

```

## Extract number and text from Description

- Extract course ID
```{r}
CourseID <- str_match(data_log$Description, "(?i)\\bcourse with id '?\\s*(\\d+)")[,2]
head(CourseID)
unique(CourseID)
```

- Extract users ID
```{r}
UserID <- str_match(data_log$Description, "(?i)\\buser with id '?\\s*(\\d+)")[,2]
head(UserID)
```

- Extract module ID
```{r}
ModuleID <- str_match(data_log$Description, "(?i)\\bcourse module id '?\\s*(\\d+)")[,2]
head(ModuleID)
unique(ModuleID)
```

 
- New dataframe with extracted ID
```{r}
#CourseID is not added since it means this datavis course
log_new <- data.frame(data_log, ModuleID, UserID)

NbUser <- count(unique((log_new %>%
              filter(!is.na(Event.name) & !is.na(ModuleID)) %>%
              select(UserID))))

```

- Split date and time
```{r}
log_new <- log_new %>%
           mutate(Date = str_split(log_new$Time, ", ", simplify = TRUE)[,1],
                    Times = str_split(log_new$Time, ", ", simplify = TRUE)[,2])

```


> So far, **`r NbUser`** different users visited the course.  There are *`r length(unique(ModuleID))-1`*  different activities that are reported in this log. Note that some activities are not available for learners. 



```{r}
# log_new <- data_log %>%
#   select(Description) %>%
#   extract(Description, 'UserID', regex = "([\\d.]+)[^\\d.]", remove = FALSE) %>%
#   mutate(data_log)
```




## Visualize some variables
- Number of times the event was conducted
```{r}
log_new %>%
  filter(!is.na(Event.name)) %>%
  count(Event.name) %>%
  mutate(rank = dense_rank(desc(n))) %>% 
  filter(rank <= 20) %>% 
  ggplot()+
  aes(x=reorder(Event.name, -n), y=n)+
  geom_bar(stat='identity')+
  labs(x="Events", y="Number of times", 
       subtitle = paste(length(unique(log_new$Event.name)),"events (Date ", format(file.info(file)["ctime"],"%Y-%m-%d"),")"))+
  ggtitle("Number of times the event was engaged in (top 22 events)")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 10))+
  coord_flip()
  
```

- Number of activity events each user engaged (top and bottom users)
```{r}
log_new %>%
  filter(!is.na(UserID)) %>%
  count(UserID) %>%
  mutate(rank = dense_rank(desc(n))) %>% 
  filter(row_number() >= max(row_number()) - 5 | rank <= 5) %>%
  ggplot()+
  aes(x=reorder(UserID, -n), y=n, 
      fill=factor(ifelse(rank <= 5,"Top 5","Bottom 5")))+
      geom_bar(stat='identity')+
  labs(x="Users' ID", y="Number of events", fill="",
       subtitle = paste(NbUser,"users ( Date ", format(file.info(file)["ctime"]
                          ,"%Y-%m-%d"),")"))+
  ggtitle("Number of events was engaged in, by users (top and bottom users)")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))

```

- Events conducted by date
```{r}
log_new %>%
  filter(!is.na(UserID)) %>%
  ggplot()+
  aes(x=fct_infreq(Date))+
  geom_bar()+
  labs(x="Date", y="Number of events", 
       subtitle = paste(length(unique(log_new$Date)),"days (Date ", format(file.info(file)["ctime"],"%Y-%m-%d"),")"))+
  ggtitle("Number of events was engaged in, by date")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 10))+
  coord_flip()
  
```
---
title: "Activity Log of UNSIAP Data Visualization E-Learning Course"
author: "Jing Zhao and Christophe Bontemps"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:  
    code_folding: hide
    highlight: tango
    number_sections: yes
    theme: lumen
  pdf_document: default
  html_notebook: default
---

```{r setup, include=FALSE}
# Code folding oprion needs echo = TRUE to work 

knitr::opts_chunk$set( message = FALSE, warning = FALSE, 
                       results =FALSE, echo = TRUE, 
                       dev="png", 
                       fig.align = 'center',
                       dev.args=list(type="cairo"), dpi=96)

# Some colors we may want to use
SIAP.color <- "#0385a8"


```


```{r libraries}
# get knit worked for Mac
library(Cairo)
library(tidyverse)
library(stringr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)

```

# Import data &  Clean data

```{r data}

date <- 20210201     # 20210127

data_log <- read.csv(paste0("Data/logs_DTV20_", date,".csv"))

file <- paste0("Data/logs_DTV20_", date,".csv") 

# I have a strange pb with the name of the Time variable. fixing it quick and dirty mode !
data_log$Time <- data_log$Ã¯..Time

```


```{r}
data_log <- data_log[!(data_log$User.full.name=="Christophe Bontemps" | data_log$User.full.name=="Ni Ni Thein" | data_log$Component=="Recycle bin"),]

```

## Extract number and text from Description

- Extract course ID
```{r}
CourseID <- str_match(data_log$Description, "(?i)\\bcourse with id '?\\s*(\\d+)")[,2]
head(CourseID)
unique(CourseID)
```

- Extract users ID
```{r}
UserID <- str_match(data_log$Description, "(?i)\\buser with id '?\\s*(\\d+)")[,2]
head(UserID)
```

- Extract module ID
```{r}
ModuleID <- str_match(data_log$Description, "(?i)\\bcourse module id '?\\s*(\\d+)")[,2]
head(ModuleID)
unique(ModuleID)
```

 
- New dataframe with extracted ID
```{r}
#CourseID is not added since it means this datavis course
log_new <- data.frame(data_log, ModuleID, UserID)

NbUser <- count(unique((log_new %>%
              filter(!is.na(Event.name) & !is.na(ModuleID)) %>%
              select(UserID))))

```

- Split date and time
```{r}
log_new <- log_new  %>%
           mutate(Date = str_split(log_new$Time, ", ", simplify = TRUE)[,1],
                    Times = str_split(log_new$Time, ", ", simplify = TRUE)[,2])

```

- Create time range
```{r}
# extract the hour and create time range. 
t <- log_new %>%
  select(Times) %>%
  extract(Times, 'Time_range', regex = "([\\d.]+)[^\\d.]", remove = FALSE) %>%
  mutate(Time_range = as.numeric(Time_range))
```

```{r}
# a loop for time range
  for (i in list(t$Time_range)) {
  i = paste0(i,":00", "~", i+1, ":00")
  log_new$Time_range <- i
}

head(log_new$Time_range)
```



> So far, **`r paste0(NbUser)`** different users visited the course.  There are **`r length(unique(ModuleID))-1`**  different activities that are reported in this log. Note that some activities are not available for learners. 


# Visualize some variables

### Events {-}
- Number of times the event was conducted
```{r}
log_new %>%
  filter(!is.na(Event.name)) %>%
  count(Event.name) %>%
  mutate(rank = dense_rank(desc(n))) %>% 
  filter(rank <= 20) %>% 
  ggplot()+
  aes(x=reorder(Event.name, n), y=n)+
  geom_bar(stat='identity')+
  labs(x="Events", y="Number of times", 
       subtitle = paste(length(unique(log_new$Event.name))-1,"events (Date ", format(file.info(file)["ctime"],"%Y-%m-%d"),")"))+
  ggtitle("Number of times the event was conducted (top 22 events)")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 8))+
  coord_flip()
  
```
- Events conducted by number of users
```{r}
log_new %>%
  filter(!is.na(Event.name)) %>%
  group_by(Event.name) %>%
  summarize(Users = n_distinct(UserID)) %>% 
  mutate(rank = dense_rank(desc(Users))) %>% 
  filter(rank <= 25) %>% 
  ggplot()+
  aes(x=reorder(Event.name, Users), y=Users)+
  geom_bar(stat='identity')+
  labs(x="Events", y="Number of users", 
       subtitle = paste(length(unique(log_new$Event.name))-1,"events (Date ", format(file.info(file)["ctime"],"%Y-%m-%d"),")"))+
  ggtitle("Events conducted by number of users (top 30 events)")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 8))+
  coord_flip()
  
```
- Users event counts (top and bottom users)
```{r}
log_new %>%
  filter(!is.na(UserID)) %>%
  count(UserID) %>%
  mutate(rank = dense_rank(desc(n))) %>% 
  filter(row_number() >= max(row_number()) - 5 | rank <= 5) %>%
  ggplot()+
  aes(x=reorder(UserID, -n), y=n, 
      fill=factor(ifelse(rank <= 5,"Top 5","Bottom 5")))+
      geom_bar(stat='identity')+
  labs(x="Users' ID", y="Number of events", fill="",
       subtitle = paste(NbUser,"users ( Date ", format(file.info(file)["ctime"]
                          ,"%Y-%m-%d"),")"))+
  ggtitle("Users event counts (top and bottom users)")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))

```
###  Events conducted by date 

>CB : should start **after the course starts** officially and then follow the date order

```{r}
log_new %>%
  filter(!is.na(UserID)) %>%
  ggplot()+
  #aes(x=fct_infreq(Date))+
  aes(x = Date)+
  geom_bar()+
  labs(x="Date", y="Number of events", 
       subtitle = paste(length(unique(log_new$Date)),"days (Date ", format(file.info(file)["ctime"],"%Y-%m-%d"),")"))+
  ggtitle("Number of events was conducted by date")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 10))+
  coord_flip()
  
```
##  Modules and activities

### Activities accessed by number of times

```{r}
log_new %>%
  filter(!is.na(ModuleID)) %>%
  count(ModuleID) %>%
  mutate(rank = dense_rank(desc(n))) %>% 
  filter(rank <= 20) %>% 
  ggplot()+
  aes(x=reorder(ModuleID, -n), y=n)+
  geom_bar(stat='identity')+
  labs(x="Activities", y="Number of times", 
       subtitle = paste(length(unique(ModuleID))-1,"activities (Date ", format(file.info(file)["ctime"],"%Y-%m-%d"),")"))+
  ggtitle("Activities accessed by number of times (top 20 activities)")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 8))+
  coord_flip()
  
```
### Activities accessed by number of users

> I changed the variable to have the lables and "see" which are the activities the most popular.  Could be good to the Module number too (1-6)!

```{r}
log_new %>%
  filter(!is.na(ModuleID)) %>%
  mutate( ModuleID.lab = paste(ModuleID,"-",Event.context)) %>%
  group_by(ModuleID.lab) %>%
  summarize(Users = n_distinct(UserID)) %>% 
  mutate(rank = dense_rank(desc(Users))) %>% 
  filter(rank <= 30) %>% 
  ggplot()+
  aes(x=reorder(ModuleID.lab, Users), y=Users)+
  geom_bar(stat='identity')+
  labs(x="Activities", y="Number of users", 
       subtitle = paste(length(unique(ModuleID))-1,"activities (Date ", format(file.info(file)["ctime"],"%Y-%m-%d"),")"))+
  ggtitle("Activities accessed by number of users (top 30 activities)")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 8))+
  coord_flip()
  
```
### Time
- Active time by events

> (I reordered here to have a distribution over the day time but do not manage to rank the date corectly... 

```{r}
log_new %>%
  filter(!is.na(Time_range)) %>%
  ggplot()+
 # aes(x=fct_infreq(Time_range))+
  aes(x= fct_reorder(Time_range, desc(Time_range)))+
  geom_bar()+
  labs(x="Time", y="Number of events", 
       subtitle = paste("JST (Date ", format(file.info(file)["ctime"],"%Y-%m-%d"),")"))+
  ggtitle("Active time by events")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 8))+
  coord_flip()
  
```
- Active time by users

```{r}
log_new %>%
  filter(!is.na(Time_range)) %>%
  group_by(Time_range) %>%
  summarize(Users = n_distinct(UserID)) %>% 
  ggplot()+
  aes(x=reorder(Time_range, Time_range), y=Users)+
  geom_bar(stat='identity')+
  labs(x="Time", y="Number of users", 
       subtitle = paste("JST (Date ", format(file.info(file)["ctime"],"%Y-%m-%d"),")"))+
  ggtitle("Active time by users")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 8), 
        axis.text.x = element_text(angle = 60))

#  coord_flip()
  
```

## Suggestions
    
### Table of learners activities
Similar to the one I send but with selection of the final date; hat is thetable can be generated for any fianl date in the past. --> the idea is to do shiny app of that and change the date...
 
 
### Heatmap of the activities: 
    * Horizontally:  time since beginnig of course
    * Vertically:  activities (first activity Module 1 on top, last activity of module 6 at the bottom)
    * heat = Nb of views (nb of users or events) of each activity  
    



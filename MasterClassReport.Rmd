---
title: "MasterClass Analytics: "
subtitle: "A generic report"
author: "Committee of Experts On Big Data and data Science"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    df_print: kable
    toc: yes
    keep_tex: yes
    fig_width: 6.5
    fig_height: 4
    extra_dependencies: float
  word_document:
    toc: yes
  html_document:
    df_print: paged
    toc: yes
    keep_md: yes
    code_folding: show
    fig_width: 6.5
    fig_height: 4
---


```{r Knitr_Global_Options, include=FALSE, cache=FALSE, echo=FALSE}
library(knitr)

# No code is shown here
knitr::opts_chunk$set(echo = FALSE)

# Other options used here 
opts_chunk$set(warning = FALSE, message = FALSE,
               fig.pos = "!H", fig.align = "center",
               autodep = TRUE, tidy = FALSE, cache = TRUE)

# In case of "weird" problem, uncomment the line below (cache issue)
opts_chunk$set(cache.rebuild=TRUE) 

# My colors:
SIAP.color <- "#0385a8"
```

`r if(knitr:::pandoc_to() == "latex") {paste("\\large")}` 


```{r libraries}
# Analysis
library(tidyverse)
library(stringr)
library(dplyr)
library(tidyr)
library(forcats)
library(lubridate)

# Nice presentation of results
library(Cairo)
library(papeR)
library(xtable)
library(data.table)
library(kableExtra)
library(modelsummary)

# Graphics 

library(plotly)
library(wesanderson)
```

 
\newpage

# Gathering the data
There are 3 files to gather + a list of countries and country codes that can be useful

```{r listcountries}
# Data used https://unstats.un.org/unsd/methodology/m49/overview/
country_df <- read.csv("SourceData/UNSD-CountryCodes.csv", sep = ";")

# Select relevant columns 
country_df <- country_df %>% 
select(ISO.alpha2.Code, Country.or.Area)%>%
  rename( Country.Code = ISO.alpha2.Code, 
          Country = Country.or.Area)

```


## The log file

> The data can be downloaded from the **Course management page** (then> reports) or here
[https://learning.officialstatistics.org/report/log/index.php?id=113](https://learning.officialstatistics.org/report/log/index.php?id=113)  ( **113** is the course id of the MasterClass course)

Download in CSV at the bottom of the page, the file is called *logs_International Data Masterclass_YYYYMMDD-XXXX.csv* depending on the day of download, XXXX is a 4-digit number. 



In the following code, I select the name of the latest downloaded log to avoid issues (and keeping tracks of previous downloads)


```{r LoadLogData}
# 1-Log File

### Recovering Log file name on the data repo (parse the repo, take the  most recent)

list.logs<- list.files(path="DataCEBD/",pattern = glob2rx(paste0("logs*")),
                       full.names = TRUE,recursive = TRUE)
name_last_logs <- list.logs[which.max(file.mtime(list.logs))]

# The raw log file is now uploaded
data.logs <- read.csv(name_last_logs)
```


## The Activity data file

> The data can be downloaded from the **Course management page** (Admin>Reports>Statistics>)  or directly from here [https://learning.officialstatistics.org/report/progress/index.php?course=113](https://learning.officialstatistics.org/report/progress/index.php?course=113)

It is important to select  (UTF-8.csv,  with comma separating) when selcting the download method at the botom of the table since some names can be in non-latin encoding. 



```{r LoadActivityData}
# 2- Activity File: 


#list.act<- list.files(path="Data/",pattern="progress",full.names = TRUE,recursive = TRUE)
list.act<- list.files(path="DataCEBD/",pattern = glob2rx(paste0("progress*")),
                       full.names = TRUE,recursive = TRUE)
name_last_act <- list.act[which.max(file.mtime(list.act))]

# Loading the activity data
data.act <- read.csv(name_last_act)
```


## The Grades data

> The data can be downloaded  directly from here[https://learning.officialstatistics.org/grade/report/grader/index.php?id=113](https://learning.officialstatistics.org/grade/report/grader/index.php?id=113)

In the export tab, select *"Plain text file"* and in the folded "Export format option" tab at the bottom select comma (radio button).  


```{r LoadGradeData}
### 3-  Grade File

#list.grades<- list.files(path="Data/",pattern="Grades",full.names = TRUE,recursive = TRUE)
list.grades<-list.files(path="DataCEBD/",pattern = glob2rx("*Master*Grades*"),
                        full.names = TRUE,recursive = TRUE)

name_last_grades <- list.grades[which.max(file.mtime(list.grades))]

# Download the latest Grades files
data.grades <- read.csv(name_last_grades)

# 4- Gathering the download date from the file name
FileDate <-as_date(file.mtime(name_last_logs))

```


##  Files that have been uploaded

The Moodle platform allows the recording of many events during a course. Several data sets can then be downloaded (in *.csv* format) for an analysis of the activity of the learners. 

So far, the data collected on **`r FileDate`** are:

-  `r name_last_logs` (*Logs on the LMS[^FileNote]*)
-  `r name_last_act `  (*Learners activities*)
-  `r name_last_grades ` (*latest grades compiled*)


[^FileNote]: Each row of the *LMS log file* is an event and so all the events (course viewed, post, attempt to a test, etc.) are recorded, with a time stamp, in a single log file.  One field gathers the detail of each event as a text message. This field can be parsed and information on the user, the activity and the event can be extracted.


##  Course specific parameters

There are some elements that could be parametrized or useful 

* CourseNameLong: for example "Machine Learning for Official Statistics and SDGs"
* CourseName: in the name of the files (such as *MLOS* or *DV22*, ...)
* CourseStartDate: in a standard format *YYYY-MM-DD*

```{r}
CourseNameLong <-" International Data Masterclass"
CourseName <- "Data MasterClass"
CourseStartDate <-"2023-11-27"
NbModules <-3
GradeThreshold <- 7
```

# Cleaning files
We have to perform several tasks before having some data to analyse.

## Cleaning the log file

### Remove lecturers/administrators from the records

>TODO: remove comments and add people who should not be counted here!!!

```{r cleaning}
#remove administrators

# data.logs <- data.logs[!( data.logs$User.full.name=="Christophe Bontemps" |
#                           data.logs$User.full.name=="Xtophe Fairweather" |
#                           data.logs$User.full.name=="Ralf Becker" |
#                           data.logs$Component=="Recycle bin"),]
```

### Remove events recorded but not useful

```{r RemoveEvents}
#remove less relevant events

All.Events <- unique(data.logs$Event.name)
# the events to remove

rem_events <- c("Tour ended", "Tour ended", "Group member added","Role assigned",
                "Course searched", "User list viewed", "User profile viewed",
                "Subscription created", 
                "User profile viewed", "User list viewed", "Course user report viewed",
                "Badge listing viewed", "User report viewed", "Course module instance list viewed",
                "Read tracking disabled", 
                "User enrolled in course", "Discussion deleted" , "Post deleted", 
                "Step shown", "Tour started", "Tour reset", "Quiz report viewed",
                "Subscription deleted", "User unenrolled from course", "Group member removed",
                "Role unassigned",  "Discussion subscription deleted", "Tag added to an item",
                "Grade deleted", tail(All.Events, n=11))

# remove events
data.logs <- data.logs[!data.logs$Event.name %in% rem_events, ]

```


### Compute time and duration of activities (not used here)


```{r TimeID}
# Main course data frame 
data.logs <- data.logs  %>%
           mutate(Date = str_split(data.logs$Time, ", " , simplify = TRUE)[,1],
                  HoursMin = str_split(data.logs$Time, ", " , simplify = TRUE)[,2])

# TO Review: Should we start at start date?  Affects the cumulative 
data.logs <- data.logs  %>%
          mutate(HoursMin = format(strptime(data.logs$HoursMin, "%H:%M"), format = "%H:%M"),
          Date = as.Date(data.logs$Date, "%d/%m/%y"))%>%
          filter(Date >= CourseStartDate) # rm before the the course started 


# Create day time range
# extract the hour and create time range. 
t <- data.logs %>%
  select(HoursMin) %>%
  extract(HoursMin, 'Time_range', regex = "([\\d.]+)[^\\d.]", remove = FALSE) %>%
  mutate(Time_range = as.numeric(Time_range))

# a loop for time range
  for (i in list(t$Time_range)) {
  i = paste0(formatC(i, format="d",flag="0",width=2),":00", "-", formatC(i+1, format="d",flag="0",width=2), ":00")
  data.logs$Time_range <- i
}

rm("t")
# unique(data.logs$Time_range)

data.logs <- data.logs %>%
  mutate(DayID = group_indices(., Date))%>%
  mutate(TimeID = as.numeric(str_extract(data.logs$Time_range, "([\\d.]+)")), 
         DayOfWeek = lubridate::wday(Date), 
         IsSunday  = as.factor(DayOfWeek ==7)) 

```

The course started on *`r format(as_date(CourseStartDate), "%A %d %B ")`.* 
The current analysis used the data compiled from the LMS on **`r format(FileDate, "%A %d %B ")`.**

# Merging files

We can use the *Activity file* to add the email address to *log file* (where only "user names" exist)

```{r MergeLogsAct}
# Step 1: Adding email address to data.logs using data.act

StudentsNames <- data.act  %>%
  select(X, Email.address) %>%
  rename( User.full.name = X)

data.logs <- left_join(data.logs ,StudentsNames, by = c("User.full.name"))
```

Now we can use email address to recover information from the participants and its grades, using the *grades file*. 

> In the SIAP LMS we have the information on **Country** and **Sex** in the "Grades file". Here it is not included!!!

```{r MergeLogsGrades}
# Step 2: Adding  Country and Institution to data.logs using data.grades
NameSex <- data.grades %>%
  mutate(TotalReal =  as.numeric(Course.total..Real.)) %>%
  select (-c(Quiz..Quiz.to.assess.learning..Real., Last.downloaded.from.this.course))
  
# Merging logs with Information from grades 
data.logs <- left_join(data.logs ,NameSex, by = c("Email.address"))

```

\newpage 

# Descriptive analysis

## Registration process


```{r Registration}
course.registration <- data.logs %>%
  select(Date, User.full.name)%>%
  arrange(Date)%>%
  distinct(User.full.name, .keep_all = TRUE)%>%
  filter(User.full.name != "-" )%>%
  arrange(Date) %>%
  group_by(Date) %>%
  mutate( countbyday = n_distinct(User.full.name)) %>%
  ungroup()%>%
  distinct(Date, countbyday)%>%
  mutate(registered = cumsum(countbyday))


course.registration %>%
ggplot() +
 aes(x = Date, weight = registered) +
 geom_bar(fill = SIAP.color, alpha = 0.5) +
 ggtitle("Learners registered by date since begining of the course (Cumulative)") +
scale_x_date(date_breaks = "weeks" , date_labels = "%e-%b-%y")+
 labs(y = "Total nb of learners enrolled", 
      x = "Date",
      caption = paste("Computed on", format(FileDate, "%e-%b-%y"),"."))+
 theme_minimal()

```

## Participants and activities on the LMS


```{r NbLearners}
ListUser <-   unique((data.logs %>%
              filter(!is.na(Event.name)) %>%
              filter(User.full.name != "-" )%>%
              select(User.full.name)))
              
NbLearners <- as.numeric(count(ListUser))

```

> As of *`r format(FileDate, "%A %d %B ")`, **`r paste0(NbLearners)`** different learners **visited**  the course*.^[This number can be smaller than the number of people who registered since it only counts **visitors**. People who did not *visit* the LMS are thus not counted] 

Many different information can be extracted  from the log file: all the events, for all learners,  as well as the precise *time* of each event are recorded. We can therefore gather information at the learner or activity level. 

<!-- After cleaning, we recorded **`r nrow(data.logs)`** events of different nature for the course.-->



## Activity data 

```{r ActivityData}

# Extract AGAIN the activity names in order (hence the Header = FALSE above!)
# Here we need to have the name of the variables in the first row!!

data.act.temp<- read.csv(name_last_act, header = FALSE)

actname <- data.frame(t(data.act.temp[1,]))
names(actname) <- "Activity"


actname <-  actname %>%
  filter(!stringr::str_detect(Activity, "X") )%>%
  filter(Activity != "") %>%
  filter(!row_number() %in% c(1,2)) %>%
  mutate(ActNb = row_number())

#rm("data.act.temp")

## Attempt to a newer version (but names of activities are with dots "General.Information"
# Extract the activity names in order (hence the Header = FALSE above!)
# actname <- data.frame(names(data.act), check.names=FALSE)
# names(actname) <- "Activity"
# 
# actname <-  actname %>%
#   filter(!stringr::str_detect(Activity, "X") )%>%
#   filter(!row_number() %in% c(1,2)) %>%
#   mutate(ActNb = row_number())
  
```

### List of all activities proposed on the course: 

``````{r Modules}
# Starting points of each module
ModStartIdx <- c(1,7 ,22,35)  # Parameters for For 5!

actname <- actname %>%
            mutate(ModuleID = case_when(between(ActNb, ModStartIdx[1], ModStartIdx[2]-1) ~ 1,
                                          between(ActNb, ModStartIdx[2], ModStartIdx[3]-1) ~ 2,
                                          between(ActNb, ModStartIdx[3], ModStartIdx[4]-1) ~ 3,
                                          between(ActNb, ModStartIdx[4], ModStartIdx[5]-1) ~ 4,
                                          between(ActNb, ModStartIdx[5], ModStartIdx[6]-1) ~ 5
                                            )) %>%
  filter(!is.na(ModuleID))


# For a  4+1   Module course 
# actname <- actname %>%
#             mutate(ModuleID = case_when(between(ActNb, ModStartIdx[1], ModStartIdx[2]-1) ~ 0,
#                                           between(ActNb, ModStartIdx[2], ModStartIdx[3]-1) ~ 1,
#                                           between(ActNb, ModStartIdx[3], ModStartIdx[4]-1) ~ 2,
#                                           between(ActNb, ModStartIdx[4], ModStartIdx[5]-1) ~ 3,
#                                           between(ActNb, ModStartIdx[5], ModStartIdx[6]-1) ~ 4, 
#                                           between(ActNb, ModStartIdx[6], ModStartIdx[7]-1) ~ 5,
#                                           between(ActNb, ModStartIdx[7], ModStartIdx[8]) ~ 6,
#                                             )) %>%
#   filter(!is.na(ModuleID))
# Specific to MLOS22
# actname <- actname %>%
#             mutate(ModuleID = ModuleID -2)

```


``````{r ModuleNb}
# Matching and adding columns

data.logs <- data.logs  %>%
  mutate(Actname = str_split(data.logs$Event.context, ": ",
                             simplify = TRUE)[,2],
         Acttype = str_split(data.logs$Event.context, ": ",
                             simplify = TRUE)[,1] ) %>%
  left_join(actname, by = c("Actname" = "Activity"))

# Removing "Course activity" from log
data.logs <- data.logs  %>% filter(Actname != CourseNameLong)


# For MLOS, Some activities have : in the name so Actname must be adjusted 
# Hence the "paste0" commands  options here to recover the full name of the activity
# data.logs <- data.logs  %>%
#   mutate(Actname = paste0(str_split(data.logs$Event.context, ": ",
#                              simplify = TRUE)[,2],": ",
#                           str_split(data.logs$Event.context, ": ",
#                              simplify = TRUE)[,3]),
#          Acttype = str_split(data.logs$Event.context, ": ",
#                              simplify = TRUE)[,1]         ) %>%
#   left_join(actname, by = c("Actname" = "Activity"))

```

```{r TabModules}
module.tab<- data.table(actname %>% 
                     filter(!stringr::str_detect(Activity, "pdf") )    %>%
                     mutate(Actname2 = paste(ActNb, "-", Activity)) %>%
                     arrange(ActNb) %>%
                     select(Actname2, ModuleID) %>%
                       filter(ModuleID >=0) %>%
                     unique() 
                   )
names(module.tab) <- c("Activity name","Module")
NbActivities <- nrow(module.tab)

# Not used
# tabl.act <-  module.tab[, .N, keyby = Actname2]
# names(tabl.act) <- c("Module", "Nb of activities")

# NbActivities <- length(unique(data.logs$Actname))
```

Each course is specific in its form and in the organisation of each Module and the number of activities proposed. After cleaning and refining the data, we  identified  **`r NbActivities`**  different *activities* proposed for the learners in *`r NbModules`* modules. 

Below is a table with the specific pedagogical activities of the course, excluding pdfs and other resources to download. 


```{r TablePrint}
# module.tab
# Better looking if long list of Modules
kable(module.tab, "latex", longtable = T, booktabs = T) %>%
  kable_styling(latex_options = c("repeat_header"), font_size = 7)

```



```{r CourseStats}
## Stat 
Qoo <-data.logs %>%
  filter(
    str_detect(Event.name, "Quiz"))%>%  
  count(n_distinct(User.full.name) )

NbLearnersQuiz <- Qoo$`n_distinct(User.full.name)`

# Subset of posts on Forums (for counts below)
Foo <-data.logs %>%
  filter(
    str_detect(Event.context, "Forum") &
    str_detect(Event.name, "posted"))%>%  
  count(n_distinct(User.full.name) )

NbLearnersPost <- Foo$`n_distinct(User.full.name)`

# Subset of Projects workshops (for counts below)
Woo <-data.logs %>%
  filter(
    (str_detect(Event.context, "Workshop")  |
    str_detect(Event.context, "Assignment:") )   &
    str_detect(Event.name, "uploaded"))%>%
  count(n_distinct(User.full.name) )

NbLearnersProject <-Woo$`n_distinct(User.full.name)`
NbLearnersActive <- max(NbLearnersQuiz,NbLearnersPost,NbLearnersProject)

# Cleaning unnecessary file
rm("Qoo", "Foo", "Woo")
```



## Attendance by sex and country

> PB here, since the information of the Sex and Country is not there!!

```{r WomenCountries}
# NbWomen <- data.logs %>%
#  select(Email.address, Sex)%>%
#   unique() %>%
#   filter(Sex == "Female") %>%
#   nrow()
# 
# NbCountries <- data.logs %>%
#   select(Country) %>%
#   filter(Country != "" | Country != "NA" | Country != "Unknown")%>%
#   unique() %>%
#   nrow()
```

 

```{r LearnersBycountry}
# temp_country <- data.logs %>%
#   filter(Country != "" | Country != "NA") %>%
#   group_by(Country) %>%
#   summarise(Learners = n_distinct(Email.address)) %>%
#   arrange(desc(Learners)) %>%
#   mutate(  differ = lag(Learners) - Learners)%>% 
#   rename(Country.Code = Country)
# 
# # adding real name of countries 
# temp_country <-  left_join(x= temp_country, y= country_df, by = c("Country.Code"))
# 
# 
# #removing when large differences 
# cond <- max(temp_country$differ, na.rm = TRUE)>100
# message <- ifelse(cond,
#                   paste("Data from ", temp_country$Country[1], "(",temp_country$Learners[1], "obs) has been removed\n as well as countries with less that 2 participants for better readability.\n "),
#                   "" )
# # Stats for text
# country_max <- temp_country %>% 
#   slice_max(Learners)%>%
#   select(Country)

```



```{r GraphBycountry}
# # Graphic 
# temp_country %>%
#   slice(ifelse(cond, -1, 1:n())) %>%
#   filter(Learners>1)%>%
#  ggplot() +
#  aes( x=reorder(Country, Learners), y=  Learners) +
#  geom_bar(aes(fill = Country),stat='identity', alpha = 0.3)+
# geom_text(aes(label= Learners, color = Country), vjust= 0.3, size=3.5,)+
#  scale_fill_hue() +
#  ggtitle(paste("Learners origin by country, (Total",NbCountries , "countries)")) +
#  labs(y = paste(NbLearners, "Learners, by country" ), 
#       x = paste("Countries"),
#       caption = paste(message, "(file date ", FileDate,")"))+
#  coord_flip() +
#  theme_minimal() +
#  theme(legend.position = "none")


```

## Certified people

We can extract information from Grades and logs to compile the number of certified people, as well as participants. 

```{r Certified}
# I create a Boolean to identify Certificate
# using  "any" returns TRUE if TRUE appears in any Actname for a participant
# Some courses have a different type of certificate in Actname --> tolower

Learners <- data.logs %>%
  group_by(Email.address, User.full.name) %>%
  mutate(Certified = any(stringr::str_detect(tolower(Actname), "certificate") ))  %>%
  ungroup() %>%
  distinct(User.full.name, .keep_all=TRUE) %>%
  select(User.full.name, Email.address, Institution, Department, TotalReal, Certified, IP.address, Time) %>%
   filter(User.full.name != "-")

# Adding Learners First and last names
Learners <- Learners %>%
  mutate(First.name = word(User.full.name, 1),
         Last.name = word(User.full.name, -1))%>%
  relocate(First.name, .after = User.full.name )%>%
  relocate(Last.name, .after = First.name ) 

```


```{r NBCertified}
NbCertificates <- nrow(subset(Learners, Certified == TRUE))
```

There are currently (as of *`r format(FileDate, "%A %d %B ")`*)  **`r NbCertificates` certified learners** in this course,  out of  **`r paste0(NbLearners)`** registered.


```{r Countries}

# Merge countries with learners

# Learners <-   left_join(x= Learners, y= country_df, by = "Country")
# Learners <- Learners %>%
#   relocate(Country, .after = Country.Code ) %>%
#   select(-Country.Code)


```



```{r ExportParticipants}
library(openxlsx)
# For export
CourseListCertified <- Learners %>% 
  filter( Certified =="TRUE") %>%
  select (User.full.name, First.name, Last.name,Email.address, Institution, Department, Time,  IP.address )
 
CourseListParticipants <- Learners %>% 
  select (User.full.name, First.name, Last.name,Email.address, Institution, Department, Certified,  IP.address )
 

# save the files
write.xlsx(CourseListCertified,
           file=paste("Output/",CourseName,"-Certified-",ymd(Sys.Date()),".xlsx", sep=""))
write.xlsx(CourseListParticipants,
           file=paste("Output/",CourseName,"-Participants-",ymd(Sys.Date()),".xlsx", sep=""))
```


##  Grades distribution

```{r ActivityTime}
### Time spent computation 
learners_Time <-  data.logs %>%
  select(Email.address,  Actname, ActNb,Date, Time) %>%
  mutate(RealTime = lubridate::dmy_hm(Time)) %>%
  group_by(Email.address, Date) %>%
  arrange(RealTime) %>%
  mutate(RawDiff = RealTime - lag(RealTime))  %>%
  filter(RawDiff < 3600)%>%
  group_by(Email.address)%>%  
  summarise(TotalTime = sum(RawDiff, na.rm = TRUE), 
            NbAct = length(unique(Actname)), 
            NbDays = length(unique(Date))) %>%
  ungroup()
```


```{r LearnersFile}
Grades <- learners_Time %>%
  left_join(data.grades, by = "Email.address") %>%
  mutate(GradeFinal = as.numeric(Course.total..Real.))

# StudentsNoShow <-  Grades %>%
#   filter(GradeFinal ==0 | is.na(GradeFinal))
NbStudentsNoShow <-  Grades %>%
  filter(GradeFinal ==0 | is.na(GradeFinal)) %>% nrow()

```





The distribution of grades is presented below, with the threshold (*`r GradeThreshold`*) highlighted.^[This graphic excludes the  *`r paste0(NbStudentsNoShow)`* participants that did not participate in any of the tests (grade =0)].  


```{r GraphGrades , fig.height=3}

# Automatic vertical scale
GradesPositive <- Grades%>% filter(GradeFinal > 0 | !is.na(GradeFinal)) 
histdata <- hist(GradesPositive$GradeFinal,
                 freq = TRUE,  breaks=100, plot=FALSE, right=FALSE)
HistHeight <- max(histdata$counts)
rm("histdata")
# Parameters for the plot
Ymax <- round(1.5*HistHeight, 0)

GradesPositive %>%
 ggplot() +
 aes(x = GradeFinal) +
 geom_histogram(bins = 100L, fill = SIAP.color, color = "white") +
 coord_cartesian(xlim=c(0,10))+
 ggtitle("Grades distribution") +
 labs(x="Grades", y=" Nb of sucessful learners",
      caption = paste("(Excluding",NbStudentsNoShow, "participants with grade = 0)") )+
 annotate("rect", xmin = GradeThreshold, xmax = max(Grades$GradeFinal, na.rm = TRUE)+1,
                  ymin = 0, ymax = Ymax,
                  fill = SIAP.color , alpha = .2)+
   annotate("text", x = GradeThreshold+1, y = Ymax*0.75,
          color= SIAP.color,
          label = "Success")+
 theme_minimal()

```




# Detailled analysis

## Learners views and completion by type of event

When on the platform, the learners can interact with the activities in different ways. These interactions with the various types of activities can be regrouped in a typology of **`r length(unique(data.logs$Event.name))-1`**  different type of events (as defined by Moodle)

```{r GraphTypeEvents}
data.logs %>%
  filter(!is.na(Event.name)) %>%
  mutate(SpecificEvent = 
           ifelse(str_detect(Event.name, "Quiz"), "Test",
                  ifelse(str_detect(Event.name, "Discussion")|
                           str_detect(Event.name, "Post"), "Forum","Other"))) %>%
  group_by(Event.name, SpecificEvent) %>%
  summarise(Learners = n_distinct(User.full.name)) %>% 
  #mutate(rank = dense_rank(desc(Learners))) %>% 
  #filter(rank <= 25) %>% 
  ggplot()+
  aes(x=reorder(Event.name, Learners), y=Learners, fill= SpecificEvent)+
  geom_bar(stat='identity')+
  labs(x="Events", y="Number of Learners", 
       subtitle = paste("The course has", length(unique(data.logs$Event.name))-1,"different events (Final date ",
                        FileDate,")"))+
  ggtitle("Total number of learners per type of event")+
  scale_fill_manual("Type of Event",values=c(SIAP.color, "grey", "darkred")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 8))+
  coord_flip()
```

    
## Learners preferred activities {-}



```{r LearnersByActivity}
LearnersByActivity <- data.logs %>%
  filter(!is.na(Event.context)) %>%
  filter(str_detect(Event.name, "viewed")) %>%  # Removing Completion without views!!
  mutate(ActID.lab = paste(ActNb,"-",Event.context)) %>%
  group_by(ActID.lab) %>%
  summarise(Learners = n_distinct(User.full.name),
            ModuleName = as.factor(unique(Actname))) 

MedianLearnersActivity <- round(median(LearnersByActivity$Learners), -1)
```


```{r GraphBarActivities, fig.height=10, fig.width=10, out.width = "80%"}

# myPaletteModules <- c('#fdbf6f', '#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c')
myPaletteModules <- c("lightgrey", '#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#fdbf6f')
myPaletteModulesDark <- c("grey", '#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#fdbf6f')

#myPaletteModules <- c("lightyellow", "yellow",'#b2df8a','#33a02c','#fb9a99','#e31a1c', "orange")

data.logs %>%
  filter(!is.na(Event.context)) %>%
  filter(Actname != CourseNameLong) %>%
  filter(ModuleID >= 0) %>% 
  filter(str_detect(Event.name, "viewed")) %>%  # Removing Completion without views!!
  mutate(ActID.lab = paste(ActNb,"-",str_trunc(Event.context, 20, "right"))) %>%
  group_by(ActID.lab) %>%
  summarise(NbLearners = n_distinct(User.full.name),
            ModuleName = as.factor(unique(Actname)),
            ModuleID = as.factor(unique(ModuleID)))  %>%
  # mutate(rank = dense_rank(desc(NbLearners))) %>
  # filter(rank <= 30) %>% 
  mutate(ActID.lab = fct_reorder(ActID.lab, NbLearners, min)) %>%
  arrange(ActID.lab) %>%  
  ggplot() +
  aes(x = ActID.lab,  y = NbLearners, fill = ModuleID) +
  geom_bar(stat='identity') +
  scale_fill_manual("ModuleID", values = myPaletteModules ) +
  # scale_fill_manual(values = c(wes_palette("Royal1")[1:2],wes_palette("Zissou1")) ) +
  geom_text(aes(label= NbLearners, color = ModuleID),
            vjust= 0.5, hjust = -0.5,  size=3.5)+
   scale_color_manual("ModuleID", values = myPaletteModulesDark ) +
  labs(x="Activities", y="Number of Learners per activity") +
  ggtitle("Activities accessed by Learners")+
  coord_flip() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), 
        text = element_text(size=12),
        axis.line = element_line(colour = "black"),
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 12))+
   annotate("text", x = 1, y = MedianLearnersActivity,
          color= "red",
          label = "Median", alpha = 0.7)+
  geom_hline( yintercept = MedianLearnersActivity,  color = "red" ) 


#p
#ggplotly(p)



```

 > *The graphic exhibits a few access differences among the **`r length(unique(data.logs$Actname))`** original activities proposed* ^[This number excludes the communication and administrative activities such as announcements, feedback, concept note, etc.] . 
 
### 10 **most viewed** activities
 
```{r Top10Activities}

DTActivities <- data.table(LearnersByActivity %>%
                          slice_max(Learners, n = 10)%>%
                          select(ModuleName, Learners))
                   
names(DTActivities) <- c( "Activity", "Nb Learners")
DTActivities

```


### 10 **least viewed** activities
 
```{r Bottom10Activities}

DTActivitiesLeast <- data.table(LearnersByActivity %>%
                             slice_min(Learners, n = 10)%>%
                             select( ModuleName, Learners))

DTActivitiesLeast <-  DTActivitiesLeast[order(-Learners)]                  
names(DTActivitiesLeast) <- c( "Activity", "Nb Learners")
DTActivitiesLeast

```

## Platform connexion

## Activities on the LMS


Since there may be an important **time difference** between the teacher and the learners, it was important to have an idea of the learner's presence on the platform by hour.  The graphic below shows the maximum number of learners for different time periods of the day. 

```{r GraphHourlyActivity, fig.height=3}
#Active time by Learners

ThreshodlLowActivity <- 10

data.logs %>%
  filter(!is.na(Time_range)) %>%
  group_by(Time_range) %>%
  summarise(Learners = n_distinct(User.full.name)) %>% 
  ggplot()+
  aes(x=reorder(Time_range, Time_range), y=Learners, 
      fill = ifelse(Learners> ThreshodlLowActivity, "High", "Low"))+
  geom_bar(stat='identity')+ 
  ggtitle("Number of Unique Visitors on the Platform by Hour")+
  labs(x="Time (NY)", y="Maximum Number of Learners", 
       subtitle = paste(" Time EST (Final date ", FileDate,")"))+
  scale_fill_manual("Activity",values=c("pink","grey")) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 8), 
        axis.text.x = element_text(angle = 60))
        
  # coord_flip()
  
```

> *Most of the activity is completed within the regular day work time (EST Time)*

**TBC**
```{r EXIT}
knitr::knit_exit()
```







```{r AboveThreshold }
NbStudentsAboveThreshold <-  Grades %>%
  filter(GradeFinal >= GradeThreshold ) %>% nrow()



# StudentsInWorkshop <-  Grades %>%
#   filter(!is.na(Grades[, grep(c("Work"), colnames(Grades))]) ) 

# Success Rates
RawSuccessRate <- round(100*NbCertificates/NbLearners, 1)
RealSuccessRate <-round(100*NbCertificates/(NbLearners - NbStudentsNoShow) , 1)


```

There are currently (as of *`r format(FileDate, "%A %d %B ")`*)  **`r NbCertificates` certified learners** in this course,  out of  **`r paste0(NbLearners)`** registered participants and of  **`r paste0(NbStudentsAboveThreshold)`** who are above the `r GradeThreshold`  threshold (and are eligible for a certificate).

 

> The "raw" success rate  is **`r RawSuccessRate`** %. However,  note that **`r paste0(NbStudentsNoShow)`**  participants did not participante in any test and have a grade of 0 (*no-shows*). So the "**real**"  success rate is  **`r RealSuccessRate`** %.


The distribution of certificates delivered by country  and by gender is the following.

```{r CertifiedbyCountry}
DTCertified <- data.table(Learners %>%  filter(Certified==TRUE))

CertifiedCountryL<-  DTCertified[, .N, keyby = c("Country", "Sex")]
CertifiedCountryL$N <- as.numeric(CertifiedCountryL$N)
CertifiedCountryW <- reshape(CertifiedCountryL, idvar = "Country", timevar = "Sex", direction = "wide")

# PB here since there is not enough certified people

# CertifiedCountryW  <- CertifiedCountryW %>%
#   replace(is.na(.), 0) %>%
#   rowwise()%>%
#   mutate(Total = sum(c(N.Female,N.Male)))%>%
#   arrange(desc(Total))
  
```

```{r TableCertifiedSex}
CertifiedSex<-  DTCertified[, .N, keyby = Sex]
names(CertifiedSex) <- c("Sex", "Nb of Certificates")
CertifiedSex
```


```{r ExportDataShuji}
library(openxlsx)
# For Shuji
# Define sheet names for each data frame
CourseListExport <- list('Grades' = DTCertified%>% arrange(desc(TotalReal)),
                     'ByCountry' = CertifiedCountryW%>% arrange(desc(.[[2]])),
                     'BySex' = CertifiedSex)
# save the file 
write.xlsx(CourseListExport,
           file=paste("Output/",CourseName,"-Certified-",ymd(Sys.Date()),".xlsx", sep=""))
```

```{r}
rm("CertifiedCountryL", "CertifiedCountryW", "CertifiedSex")
```


```{r ExportDataReport}
#For report
CourseReportExport <- data.frame(NbLearners, NbCertificates)
write.xlsx(CourseReportExport,
           file=paste("Output/",CourseName,"-Report-",ymd(Sys.Date()),".xlsx", sep=""))


```

##  Success rate

The success rate (`r RealSuccessRate` %) can be analysed by country and gender.


```{r GraphSuccessByCountry}
MinLearners <- 5
Learners %>%
 filter(Country != "" | Country != "NA") %>%
 filter(TotalReal > 0 | !is.na(TotalReal)) %>%
  mutate( One = 1, 
          OneC = ifelse(Certified ==TRUE, 1, 0),
          Certified = as.factor(Certified),
          Country = as.factor(Country)) %>%
    group_by(Country) %>%
  mutate (TotalC = sum(OneC), 
          Total = sum(One), 
          PercentC = TotalC/Total) %>%
  ungroup() %>%
  filter(Total >= MinLearners)%>%
  ggplot() +
  aes(x = reorder(Country, PercentC) , y = One , fill = Certified)  +
  geom_bar(position="fill", stat="identity",  alpha = 0.5) +
  ggtitle("Sucess rate by country") +
  labs(x="Country", y="Percentage of sucess", 
      caption = paste(" Only countries with more than", MinLearners, "participants are represented \n Participants with a grade of  0 (`noshows`) excluded \n
                     (date ", FileDate,")"))+
  guides(fill = guide_legend(title = "Sucess")) +
  theme_minimal()+
   annotate("text", x = 1, y = RealSuccessRate/100,
          color= "red",
          label = "Mean", alpha = 0.7)+
  geom_hline( yintercept = RealSuccessRate/100,  color = "red" ) +
  theme(legend.position = "bottom")+ 
  coord_flip()

```


```{r GraphSuccessBySex, fig.height= 3}
Learners %>%
 filter(Country != "" | Country != "NA")%>%
  filter(TotalReal > 0 | !is.na(TotalReal)) %>%
  mutate( One = 1, 
          Certified = ifelse(Certified == 1, "Yes", "No" )) %>%
  ggplot() +
  aes(x = Sex , y = One , fill = Certified) +
  geom_bar(position="fill", stat="identity",  alpha = 0.5) +
  ggtitle("Sucess rate by gender") +
  labs(x="Gender", y="Percentage of sucess", 
      caption = paste(" Participants with a grade of 0 (`noshows`) excluded \n
                     (date ", FileDate,")"))+
  theme_minimal()+
  geom_hline( yintercept = RealSuccessRate/100,  color = "red" ) +
  theme(legend.position = "bottom")+ 
  coord_flip()

```


###  Grades distribution by sex and country

```{r densitySex, fig.height=3}
library(ggridges)
GradesPositive %>%
 filter(Country != "" | Country != "NA")%>%
  group_by(Sex) %>%
  mutate(AvgGrade = mean(GradeFinal, na.rm =TRUE), 
         NbLearners = n_distinct(Email.address))  %>%
  ungroup() %>%
  filter(NbLearners >5) %>%
  ggplot() +
  aes(x = GradeFinal , y = reorder(Sex, AvgGrade) , fill = Sex) +
  xlim( c(0,max(GradesPositive$GradeFinal)+1))+
  #geom_density_ridges(stat="binline", bins=20) +
  # geom_density_ridges( alpha = 0.3) +
  stat_density_ridges(quantile_lines = FALSE, quantiles = 2, 
                        jittered_points = TRUE,
                        position = position_points_jitter(width = 0.05, height = 0),
                        point_shape = '|', point_size = 2, point_alpha = 0.3, 
                       alpha = 0.3
                      ) +
  scale_fill_viridis_d(name = "Quintiles") +
  
  #geom_jitter(color= SIAP.color, size=0.6, alpha=0.9) +
  ggtitle("Distribution of grades by Sex ") +
  labs(x="Final Grades", y=" Sex ", 
      subtitle = paste("(date ", FileDate,")")) +
    theme_ridges(grid = FALSE) +
  geom_vline( xintercept = GradeThreshold,  color = "red" ) +
  annotate("text", x = GradeThreshold+12, y = 0.75,
          color= "red",
          label = "Success")+
  #theme_minimal()+
  theme(legend.position = "none")
 

```

```{r densityCountry, fig.height=5}
#library(ggridges)
GradesPositive %>%
 filter(Country != "" | Country != "NA")%>%
  group_by(Country) %>%
  mutate(AvgGrade = mean(GradeFinal, na.rm =TRUE), 
         NbLearners = n_distinct(Email.address))  %>%
  ungroup() %>%
  filter(NbLearners >5) %>%
  ggplot() +
  aes(x = GradeFinal , y = reorder(Country, AvgGrade) , fill = Country) +
  xlim( c(0,max(GradesPositive$GradeFinal)+1))+
  #geom_density_ridges(stat="binline", bins=20) +
  # geom_density_ridges( alpha = 0.3) +
  stat_density_ridges(quantile_lines = FALSE, quantiles = 2, 
                        jittered_points = TRUE,
                        position = position_points_jitter(width = 0.05, height = 0.1),
                        point_shape = '|', point_size = 2, point_alpha = 0.3, 
                       alpha = 0.3
                      ) +
  #geom_jitter(color= SIAP.color, size=0.6, alpha=0.9) +
  ggtitle("Distribution of grades by countries ") +
  labs(x="Final Grades",
       y=" Countries", 
      caption = paste("Countries with more than 5 participants \n
                     (date ", FileDate,")"))+
    theme_ridges(grid = FALSE) +
  geom_vline( xintercept = GradeThreshold,  color = "red" ) +
  annotate("text", x = GradeThreshold+12, y = 0.75,
          color= "red",
          label = "Success")+
  #theme_minimal()+
  theme(legend.position = "none")
 

```



##  Events conducted by date and time of the day{-} 

We observe events over the whole period of the course and represent the activities by day. 

```{r GraphActivityByDate}
# Specific to Facilitated courses

data.logs %>%
  mutate(ParticularDays = ifelse(DayOfWeek ==1, "Sunday",
                                 ifelse(DayOfWeek ==WebinarDay & DayID < 7 * NbModules,
                                        "Webinar day", "Regular"))  ) %>%
  filter(!is.na(User.full.name)) %>%
  ggplot()+
  #aes(x=fct_infreq(Date))+
  aes(x = as.factor(DayID),  fill = ParticularDays)+
  geom_bar(color = "white" )+
  labs(x="Day since start", y="Number of events",
       subtitle = paste("Nb of days", length(unique(data.logs$Date)),"(Final date: ",
                        FileDate,")"))+
  ggtitle("Number of events recorded on the platform by date")+
  scale_fill_manual("Activity",values=c( SIAP.color, "grey", "orange")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8),
        axis.line = element_line(colour = "black"),
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 10))

```



 
## Activities along the course span: 

This *heatmap* is an attempt to visualize the activities on the platform over time.  The coding is the following:

-  Horizontally:  Nb of days since beginning of course
-  Vertically:  Activities (Module 1 at the bottom, module 6 at the top)
-  Cells (color):  Nb of views (Nb of Learners) for each activity each day


```{r HeatMap}
library(colorspace)
data.logs %>%
 filter(!is.na(ActNb))  %>%
  mutate(ActID.lab = paste(ActNb,"-",str_trunc(Actname, 30, "right") )) %>%
  group_by(ActID.lab, Date) %>%
  summarise(Learners = n_distinct(User.full.name)) %>% 
  ggplot()+
  aes(x=Date, y=fct_rev(fct_infreq(ActID.lab)), fill=Learners)+
  geom_tile( )+
  scale_fill_gradientn(colours= diverge_hcl(14), trans = "log", 
                      labels =  scales::comma_format(accuracy=1))+
  scale_y_discrete(label=function(x) abbreviate(x, minlength=15))+
  labs(x="Date", y="Activities", 
       fill = "Nb of learners", 
       subtitle = paste("Final date ", FileDate), 
       caption = " Vertical lines indicate module opening")+
  ggtitle("Heatmap of the activities")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=14),
        panel.background = element_blank(), text = element_text(size=10), 
        axis.line = element_line(colour = "black"), 
        axis.text.y = element_text(face= "plain", size=4.5, color="black"),
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 8))+
  coord_fixed(ratio = 0.5 )
```


## Learners activities and grades

Over the **`r NbLearners`** unique learners[^MyNote] registered for the course,  **`r NbLearnersQuiz`** attempted  to at least one test and  **`r Grades%>% filter(NbDays > 6 ) %>% nrow()`** visited the LMS at more than **6 different dates** (some learners have completed several modules within the same day).  

[^MyNote]: We removed SIAP's lecturers from the list  as well as some learners registered with different emails, we count here **unique** learners.  

In the graphic below we highlight learners (`r round(Grades%>% filter(GradeFinal >GradeThreshold & NbAct > 0.6*max(Grades$NbAct, na.rm = TRUE) ) %>% nrow(), 1)` participants) that have succeed in their tests and completed  more than 2/3 of the activities proposed on the LMS. All learners should be in that zone.  

```{r GradesVsActivities}

# Here we put the points AFTER the annotation for Plotly... 
p <-Grades %>%
  filter(Country != "") %>%
 ggplot() +
 ggtitle("Test Scores vs Number of Activities Viewed") +
 labs(x="Nb of activities viewed", y=" Total Grade ", 
      subtitle = paste0("Each dot is a participant, coloured by country" ),
       caption=  paste("Date", FileDate) )+
  ylim( c(0,GradeMax))+
  annotate("rect", 
           xmin= round(0.6* max(Grades$NbAct, na.rm = TRUE), 0), 
           xmax = max(Grades$NbAct +1 , na.rm = TRUE)+1,
           ymin = GradeThreshold,
           ymax = GradeMax, 
           fill = "grey",  alpha = 0.1, 
          color= SIAP.color, alpha = 0.1) +
 aes(x = NbAct, y = GradeFinal, color = Country) +
 geom_jitter( width = 0.5, height = 0.5, alpha = 0.6) +
 # facet_wrap(vars(Country)) +
 scale_color_hue() +
 theme_minimal()+
 theme(legend.position = "none")
p
#Interactive plot
#ggplotly(p)
```

## Activities viewed and time spent by learners 

```{r}

# Subset of students spending more than 3hours/week (for counts below)
Too <-Grades %>%
 #mutate(TotalTimeHour = TotalTime/3600) %>%
  filter(
    !is.na(TotalTime),
    as.numeric(TotalTime)> 3*NbModules*3600
    )%>%  
  count(n_distinct(Email.address) )

NbLearners3hours <- max(Too$n, 0)
rm("Too")

```

The time spent by learners on the platform is, of course, proportional to the number of activities viewed, with a greater heterogeneity for the most serious learners who viewed most of the activities.[^Time] 

> It is still difficult to measure precisely the time spent by learners on the LMS,  but **`r NbLearners3hours`**  learners have spent more than 3 hours/Module on the course.

[^Time]: We do not always observe when someone leaves the platform. The duration reported here may reflect *"shadow"* activities while the learner was doing something else.  


```{r TimeVsActivities}

p <- Grades %>%
 filter(!is.na(Country)) %>%
mutate(TotalTime = TotalTime/60, 
        Certification = as.factor(ifelse(GradeFinal >= GradeThreshold, "Succeed", "Failed"))) %>%
 ggplot() +
 aes(x = NbAct, y = TotalTime,
     colour =  Certification,
     toto = Email.address) +   # for plotly
  # Toto is a trick to have names in plotly
 # geom_jitter(aes(size=as.numeric(TotalTime)), width = 0.5, height = 0.5, alpha = 0.6) +
 geom_jitter(size = 3,  alpha = 0.6) +
 ggtitle("Total Time Spent (estimated) vs Number of Activities Viewed") +
 labs(x="Nb of activities viewed", y=" Total time spent by learners (in min)", 
      subtitle = paste0("Each dot is a participant. ", NbLearners3hours," learners spent more than 3 hours/week"), 
      caption=  paste("Date", FileDate) )+
 geom_hline (aes(yintercept = 3*NbModules*60), color = SIAP.color) +
 annotate("text", x = 15, y = 3*NbModules*60 + 200,
          color= SIAP.color,
          label = "Course  requirement (3 hours/Module)")+
# geom_vline (aes(xintercept =  median(TotalTime))) +
# facet_wrap(vars(Country)) +
 scale_color_hue() +
 theme_minimal()+
 theme(legend.position = "bottom")

p
#Interactive plot
#ggplotly(p)


```

## Activities viewed and visits on the LMS

```{r VisitsVsActivities}

Grades %>%
 filter(!is.na(Country)) %>%
 mutate( 
       Certification = as.factor(ifelse(GradeFinal >= GradeThreshold, "Succeed", "Failed"))) %>%
 ggplot() +
 aes(x= NbDays, y = NbAct, 
     colour = Certification)+
 geom_jitter(size = 3,  alpha = 0.5, width = 0.1) +
 scale_x_continuous(breaks=seq(from = 0, to = max(Grades$NbAct)+2, by =2))+
 ggtitle("Activity of learners and visits to the LMS") +
 labs(x="Nb of visits on the LMS (unique days)", 
      y=paste0(" Nb of activities visited \n (max =", NbActivities,")"), 
      subtitle = paste0("Each dot is a participant, couloured by success"), 
      caption=  paste("Date", FileDate) )+
 theme_minimal()+
 theme(legend.position = "bottom", 
       panel.grid.minor = element_blank())



```

```{r reportexport}
library(here)
# Report.name <- paste0("Report-", CourseName,"-", FileDate)
# 
# # Export
# file.copy(from = here("GenericReport.pdf"),
#           to = paste0(here("Output/Reports"),"/",Report.name,".pdf"))





```


```{r Cheaters}

Cheaters <- read.csv("SourceData/CheatersADV23.csv", sep = ";")%>%
  rename(User.full.name = First.name...Surname)

# Merge with learners
Cheaters <- left_join(x= Cheaters, y= Learners, by = "User.full.name")


Cheaters <- Cheaters %>%
  select(-c(TotalReal , Certified))

# save the file 
# write.xlsx(Cheaters,
#            file=paste("Output/",CourseName,"-Cheaters-",ymd(Sys.Date()),".xlsx", sep=""))

```



# Lerner's paths

```{r LearnersTracks}
# Creating Learners Chronology

LearnersPaths <- data.logs %>%
  filter(!is.na(ActNb)) %>%
  distinct(User.full.name, Time,.keep_all = TRUE) %>%
  group_by(User.full.name) %>%
  arrange(Time) %>%
  mutate( seq_idx  = row_number()
  ) %>%
  ungroup()

# Sequence of steps by learners 
LearnersPaths <- LearnersPaths   %>%
  group_by(User.full.name) %>%
  arrange(seq_idx) %>%
  mutate( 
    Increasing  =  !is.unsorted(ActNb), 
    Nbre_Steps = n(), 
    next_step = c(ActNb[-1], NA ),
    step_diff = (next_step - ActNb)-1, 
    
    sum_neg_diff = sum( ifelse(step_diff < 0 , step_diff + 1, 0) ),
    I_back = ifelse(step_diff < 0 , 1, 0), 
    Nbre_back = sum(I_back, na.rm =TRUE),
    Tx_back =  Nbre_back /Nbre_Steps,
    
    total_diff = sum(step_diff , na.rm =TRUE),
    abs_tot_diff = sum(abs(step_diff) , na.rm =TRUE),
    rel_diff = abs_tot_diff/Nbre_Steps, 
    max_diff = max(abs(step_diff) , na.rm =TRUE)
  ) %>%
  ungroup() 

# some stats to do here...

```


```{r LearnersPath}
# maybe change the definition of "clicks"  --> seq_idx
## Trajectories of learners....

NminStep <- 200    #Selecting learners for  graph
df <- LearnersPaths  %>%
  filter(Certified == TRUE,
         Nbre_Steps >= NminStep ) %>%
  group_by(User.full.name) %>%
  select(User.full.name, ActNb, Actname, ModuleID, Certified, Country,
         seq_idx, Nbre_Steps, Increasing, next_step, step_diff) %>% 
  ungroup() %>%
  arrange(User.full.name, seq_idx)

# Jitter plot 

p <- ggplot(df, aes(x = seq_idx,
                    y= ActNb,
                    group = User.full.name,
                    Act = Actname
                    # colour =  User.full.name
                    )) +
  geom_line(alpha = 0.2, size = 0.8,
            show.legend = FALSE,
            aes(y = ActNb, 
                x = jitter(as.numeric(seq_idx, 0.5)) ,
                group=factor(User.full.name))) +
  labs(title= paste("Trajectory of",length(unique(df$User.full.name)),"learners clicking at least", NminStep,"times"  ), 
       y = "Course activity", x = "Learners chronological sequence (clics)") +
  theme_minimal()

# p

ggplotly(p)

```


# Leftovers


```{r specific }
# Catching information on a specific user 
toto <- data.logs %>% 
  filter(str_detect(User.full.name, "Fangcao")) %>%
  select( User.full.name, Date, ModuleID,  Actname)%>%
  unique()

unique(toto$Date) 
```


```{r, eval = FALSE}

NbSelect <- 10  # Best and worst students (in terms of events)

#Learners event counts (top and bottom Learners)
data.logs %>%
  filter(!is.na(User.full.name), 
         User.full.name != "-") %>%
  count(User.full.name) %>%
  mte(rank = dense_rank(desc(n))) %>% 
  filter(row_number() >= max(row_number()) - NbSelect | rank <= NbSelect) %>%
  ggplot()+
  aes(x=reorder(User.full.name, n), y=n, 
      fill=factor(ifelse(rank <= NbSelect, paste("Top", NbSelect),paste("Bottom", NbSelect)))) +
  geom_bar(stat='identity') +
  labs(x="Learners' ID", y="Number of events", fill="",
       subtitle = paste(NbLearners,"Learners (Final Date ", FileDate,")"))+
  ggtitle("Learners event counts (top and bottom Learners)")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  coord_flip()

```

### Activities accessed by number of Learners


```{r}
data.logs %>%
  filter(!is.na(ActNb)) %>%
  mutate( ActID.lab = paste(ActNb,"-",Event.context, "-", ModuleID)) %>%
  group_by(ActID.lab) %>%
  summarise(Learners = n_distinct(User.full.name)) %>% 
  mutate(rank = dense_rank(desc(Learners))) %>% 
  filter(rank <= 40) %>% 
  ggplot()+
  aes(x=reorder(ActID.lab, Learners), y=Learners)+
  geom_bar(stat='identity')+
  labs(x="Activities", y="Number of Learners", 
       subtitle = paste(length(unique(actname))-1,"activities (Final Date ", as.Date(as.character(FileDate),format = "%Y%m%d"),")"))+
  ggtitle("Activities accessed by number of Learners (top 30 activities)")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 8))+
  coord_flip()
  
```




```{r}
data.logs %>%
  filter(!is.na(ActNb),
         Date <= FileDate) %>%
  mutate( ActID.lab = paste(ActNb,"-",Event.context)) %>%
  group_by(ActID.lab) %>%
  summarise(Learners = n_distinct(User.full.name)) %>% 
  #mutate(rank = dense_rank(desc(Learners))) %>% 
  #filter(rank <= 30) %>% 
  ggplot()+
  aes(x=reorder(ActID.lab, Learners), y=Learners)+
  geom_bar(stat='identity')+
  labs(x="Activities", y="Number of Learners", 
       subtitle = paste(nrow(subset(unique(data.logs[c("ActNb", "Date")]), Date==FileDate)),"activities (Date ", FileDate,")"))+
  ggtitle("Activities accessed by number of Learners")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        panel.background = element_blank(), text = element_text(size=8), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 8))+
  coord_flip()
```

 
 - Sort by the frequency of activities 
```{r, fig.width=12,fig.height=18}
#Both Date and Date ID work. Date: the specific date since beginning; DayID: the first date = 1, and the second = 2, ...
data.logs %>%
  filter(!is.na(ActNb)) %>%
  mutate(ActID.lab = paste(ActNb,"-",Event.context, "-")) %>%
  group_by(ActID.lab, Date) %>%
  summarise(Learners = n_distinct(User.full.name)) %>% 
  ggplot()+
  aes(x=Date, y=fct_rev(fct_infreq(ActID.lab)), fill=Learners)+
  geom_tile()+
  labs(x="Date", y="Activities", 
       subtitle = paste("Final date ", as.Date(as.character(FileDate),format = "%Y%m%d")))+
  ggtitle("Heatmap of the activities")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=14),
        panel.background = element_blank(), text = element_text(size=10), 
        axis.line = element_line(colour = "black"), 
        plot.subtitle = element_text(hjust = 0.5, size=8),
        axis.title.y = element_text(size = 10))+
  coord_fixed(ratio = 0.5)

```



```{r }
# data.logs <-  data.logs %>%
#   group_by(User.full.name, Date, Actname) %>%
#   mutate( TimeperActivity = lubridate::as.duration(Time)) %>%
#   group_by(User.full.name, Date) %>%
#   mutate(TimeperDay = sum(TimeperActivity)) %>%
#   ungroup()
#  Still a problem in this computation since there may be hours btween two event...
```


```{r}

p <- Grades %>%
 filter(!is.na(Country)) %>%
mutate(TotalTime = TotalTime/60) %>%
 ggplot() +
 aes(x = NbAct, y = GradeFinal, colour = Country, toto = Email.address) +
 geom_jitter(aes(size=as.numeric(TotalTime)), width = 0.5, height = 0.5, alpha = 0.6) +
# geom_vline (aes(xintercept =  median(TotalTime))) +
# facet_wrap(vars(Country)) +
 scale_color_hue() +
 theme_minimal()+
 theme(legend.position = "bottom")

p
#ggplotly(p)

```




# leftovers




```{r}

Grades%>%
 filter(Country != "" | Country != "NA")%>%
 group_by(Country)%>%
  summarise(Learners = n()) %>%
 ggplot() +
 aes( x=reorder(Country, Learners), y=  Learners) +
 geom_bar(aes(fill = Country), stat='identity', alpha = 0.3)+
 scale_fill_hue() +
 ggtitle("Learners origin") +
 labs(y = "Nb of learners enrolled", 
      x = "Countries (Ordered by Nb of participants)",
      caption = paste("(as of ", FileDate,")"))+
 coord_flip() +
 theme_minimal() +
 theme(legend.position = "none")


```

```{r density1, fig.height=4}
library(ggridges)
Grades %>%
 filter(Country != "" | Country != "NA")%>%
  filter(GradeFinal > 0) %>%
  group_by(Country) %>%
  mutate(AvgGrade = mean(GradeFinal, na.rm =TRUE), 
         NbLearners = n_distinct(Email.address))  %>%
  ungroup() %>%
  filter(NbLearners >5) %>%
  ggplot() +
  aes(x = GradeFinal , y = reorder(Country, AvgGrade) , fill = Country) +
  xlim( c(0,65))+
  #geom_density_ridges(stat="binline", bins=20) +
  # geom_density_ridges( alpha = 0.3) +
  stat_density_ridges(quantile_lines = FALSE, quantiles = 2, 
                        jittered_points = TRUE,
                        position = position_points_jitter(width = 0.05, height = 0),
                        point_shape = '|', point_size = 2, point_alpha = 0.3, 
                       alpha = 0.3
                      ) +
  #geom_jitter(color= SIAP.color, size=0.6, alpha=0.9) +
  ggtitle("Distribution of grades by countries ") +
  labs(x="Final Grades", y=" Countries (Ordered by Avg Grades) ", 
      subtitle = paste("Countries with more than 5 participants", "(date ", FileDate,")")) +
    theme_ridges(grid = FALSE) +
  #theme_minimal()+
  theme(legend.position = "none")
 

```

```{r}

Grades %>%
 filter(Country != "" | Country != "NA")%>%
 group_by(Country) %>%
 summarise(Learners = n_distinct(Email.address)) %>%
 ggplot() +
 aes( x=reorder(Country, Learners), y=  Learners) +
 geom_bar(aes(fill = Country),stat='identity', alpha = 0.3)+
geom_text(aes(label= Learners, color = Country), vjust= 0.3, size=3.5,)+
 scale_fill_hue() +
 ggtitle("Learners origin") +
 labs(y = "Nb of learners enrolled", 
      x = "Countries (Ordered by Nb of participants)",
      subtitle = paste("(date ", FileDate,")"))+
 coord_flip() +
 theme_minimal() +
 theme(legend.position = "none")


```

```{r density2, fig.height=4}
library(ggridges)
Grades %>%
 filter(Country != "" | Country != "NA")%>%
  filter(GradeFinal > 0) %>%
  group_by(Country) %>%
  mutate(AvgGrade = mean(GradeFinal, na.rm =TRUE), 
         NbLearners = n_distinct(Email.address))  %>%
  ungroup() %>%
  filter(NbLearners >5) %>%
  ggplot() +
  aes(x = GradeFinal , y = reorder(Country, AvgGrade) , fill = Country) +
  xlim( c(0,100))+
  #geom_density_ridges(stat="binline", bins=20) +
  # geom_density_ridges( alpha = 0.3) +
  stat_density_ridges(quantile_lines = FALSE, quantiles = 2, 
                        jittered_points = TRUE,
                        position = position_points_jitter(width = 0.05, height = 0),
                        point_shape = '|', point_size = 2, point_alpha = 0.3, 
                       alpha = 0.3
                      ) +
  #geom_jitter(color= SIAP.color, size=0.6, alpha=0.9) +
  ggtitle("Distribution of grades by countries ") +
  labs(x="Final Grades", y=" Countries (Ordered by Avg Grades) ", 
      subtitle = paste("Countries with more than 5 participants", "(date ", FileDate,")")) +
    theme_ridges(grid = FALSE) +
  #theme_minimal()+
  theme(legend.position = "none")
 

```


```{r}

# Graphics on special activities

Special <- "Satellite"

toto <-  data.logs %>%
  filter(!is.na(Event.name)) %>%
  filter(str_detect(Event.context, Special))%>%
  group_by(Event.context)%>%
  summarise(Learners = n_distinct(User.full.name), 
            Module = max(ModuleID))


ggplot(toto) +
  aes(x = Event.context, y =  Learners) +
  geom_bar(aes(fill = Event.context), stat = "identity", alpha = 0.5) +
  ggtitle(paste(Special, "activities")) +
 labs(y = "Nb of learners enrolled", 
      subtitle = paste("(date ", FileDate,")"))+
  coord_flip() +
  theme_minimal()+
 theme(legend.position = "none")
```


